# Fase 3: Deploy no Kubernetes

Este documento descreve o deploy da aplica√ß√£o FastAPI containerizada em cluster Kubernetes local utilizando Kind, com configura√ß√£o de manifests otimizados para produ√ß√£o.

## üìã Vis√£o Geral

Esta fase implementa orquestra√ß√£o Kubernetes, incluindo:
- Configura√ß√£o do cluster Kind com port mapping
- Manifests Kubernetes (Deployment + Service) otimizados
- Deploy da aplica√ß√£o com 2 r√©plicas e rolling updates
- Health checks autom√°ticos e monitoramento
- Exposi√ß√£o via NodePort para acesso local

## üéØ Objetivos

- [x] Configurar cluster Kind com port mapping adequado
- [x] Criar manifests Kubernetes otimizados
- [x] Deploy da aplica√ß√£o com 2 r√©plicas
- [x] Configurar Service NodePort (porta 30001)
- [x] Implementar health checks (liveness/readiness)
- [x] Validar aplica√ß√£o funcionando via Kubernetes

## üõ†Ô∏è Pr√©-requisitos

### Software Necess√°rio
- **Kind** ou **Minikube** (Kubernetes local)
- **kubectl** configurado e funcionando
- **Docker** rodando (para Kind)
- **Imagem Docker** da Fase 2 no Docker Hub

### Sistema Operacional
- ‚úÖ **Windows 10/11 com WSL2** (m√©todo utilizado neste guia)

### Valida√ß√£o do Ambiente
```bash
# Verificar Kind e kubectl
kind version
kubectl version --client

# Verificar Docker (necess√°rio para Kind)
docker --version
docker info
```

## üöÄ Configura√ß√£o do Cluster Kubernetes

### 1. Cluster Kind com Port Mapping

#### 1.1 Configura√ß√£o do Cluster
**Arquivo:** `k8s/kind-config.yaml` (configura√ß√£o local)

üí° **Cluster j√° configurado** - Use a configura√ß√£o existente com port mapping para porta 30001.

**Configura√ß√£o t√≠pica utilizada:**
```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: fastapi-cluster
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 30001
    hostPort: 30001
    protocol: TCP
```

#### 1.2 Verifica√ß√£o do Cluster Existente
```bash
# Verificar cluster em funcionamento
kubectl cluster-info
kubectl get nodes

# Verificar se port mapping est√° ativo
docker port fastapi-cluster-control-plane
```

![Cluster Funcionando](./images/fase3/cluster-running.png)

### 2. Manifests Kubernetes

#### 2.1 Deployment da Aplica√ß√£o
**Arquivo:** `k8s/deployment.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-app
  labels:
    app: fastapi-app
    project: compassuol-devops
spec:
  replicas: 2
  selector:
    matchLabels:
      app: fastapi-app
  template:
    metadata:
      labels:
        app: fastapi-app
    spec:
      containers:
      - name: fastapi-app
        image: seu_usuario_dockerhub/fastapi-jenkins:latest
        ports:
        - containerPort: 8000
        
        # Health checks para monitoramento
        livenessProbe:
          httpGet:
            path: /time
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 30
        
        readinessProbe:
          httpGet:
            path: /time
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 10
        
        # Security context (usu√°rio n√£o-root)
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000

---
apiVersion: v1
kind: Service
metadata:
  name: fastapi-service
  labels:
    app: fastapi-app
spec:
  selector:
    app: fastapi-app
  ports:
  - port: 80
    targetPort: 8000
    nodePort: 30001
  type: NodePort
```

![Manifests Kubernetes](./images/fase3/k8s-manifests.png)

#### 2.2 Pontos Importantes dos Manifests

**üîß Configura√ß√µes de Produ√ß√£o:**
- ‚úÖ **2 R√©plicas**: High availability
- ‚úÖ **Rolling Updates**: Deploy sem downtime
- ‚úÖ **Health Checks**: Liveness + Readiness probes
- ‚úÖ **Security Context**: runAsNonRoot + UID 1000
- ‚úÖ **NodePort 30001**: Acesso via localhost
- ‚úÖ **Labels organizados**: Para pipeline Jenkins

### 3. Deploy da Aplica√ß√£o

#### 3.1 Verifica√ß√£o do Deploy Existente
```bash
# Verificar aplica√ß√£o j√° deployada
kubectl get deployments
kubectl get pods -l app=fastapi-app
kubectl get services
```

![Deploy Ativo](./images/fase3/deployment-status.png)

#### 3.2 Verifica√ß√£o do Status
```bash
# Verificar pods em detalhes
kubectl get pods -l app=fastapi-app -o wide

# Verificar logs da aplica√ß√£o
kubectl logs -l app=fastapi-app

# Verificar descri√ß√£o do deployment
kubectl describe deployment fastapi-app
```

#### 3.3 Verifica√ß√£o dos Health Checks
```bash
# Verificar eventos (health checks)
kubectl get events --sort-by=.metadata.creationTimestamp

# Status dos pods (Running + Ready)
kubectl get pods -l app=fastapi-app
# Resultado esperado: STATUS: Running, READY: 1/1
```

![Pods Running](./images/fase3/pods-running.png)

### 4. Teste da Aplica√ß√£o

#### 4.1 Acesso via NodePort
```bash
# Testar endpoint principal
curl http://localhost:30001/time

# Testar documenta√ß√£o
curl http://localhost:30001/docs

# Testar todos os endpoints
curl http://localhost:30001/color
curl http://localhost:30001/cat
```

#### 4.2 Teste via Navegador
**Acessar:** http://localhost:30001/docs

![Swagger K8s](./images/fase3/swagger-k8s.png)

### 5. Comandos √öteis de Monitoramento

#### 5.1 Monitoramento em Tempo Real
```bash
# Watch pods em tempo real
kubectl get pods -l app=fastapi-app -w

# Logs em tempo real
kubectl logs -f deployment/fastapi-app

# Verificar uso de recursos
kubectl top pods -l app=fastapi-app
```

#### 5.2 Port Forward (Alternativo)
```bash
# Se NodePort n√£o funcionar, usar port-forward
kubectl port-forward service/fastapi-service 8080:80

# Testar via port-forward
curl http://localhost:8080/time
```

---

## ‚úÖ Entreg√°veis Conclu√≠dos

| Item | Status | Evid√™ncia |
|------|--------|-----------|
| Cluster Kind configurado | ‚úÖ | Port mapping 30001 funcionando |
| Manifests Kubernetes criados | ‚úÖ | Deployment + Service otimizados |
| Aplica√ß√£o deployada | ‚úÖ | 2 r√©plicas rodando com health checks |
| Service NodePort ativo | ‚úÖ | Acesso via localhost:30001 |
| Health checks funcionando | ‚úÖ | Liveness + Readiness probes ativos |
| Alta disponibilidade validada | ‚úÖ | Load balancing entre r√©plicas |

## üì∏ Imagens de Evid√™ncia

As imagens que demonstram a conclus√£o desta fase est√£o organizadas em:

```
docs/images/fase3/
‚îú‚îÄ‚îÄ cluster-running.png         # Cluster Kind funcionando (kubectl get nodes)
‚îú‚îÄ‚îÄ k8s-manifests.png          # Manifests deployment.yaml no VS Code
‚îú‚îÄ‚îÄ deployment-status.png      # Deploy ativo (kubectl get all)
‚îú‚îÄ‚îÄ pods-running.png           # Pods executando com health checks
‚îî‚îÄ‚îÄ swagger-k8s.png            # Swagger UI via Kubernetes (localhost:30001)
```

## üîß Troubleshooting Comum

### Problema 1: Kind n√£o consegue criar cluster
```bash
# Erro: "failed to create cluster"
# Verificar Docker rodando
docker info

# Deletar cluster existente se necess√°rio
kind delete cluster --name fastapi-cluster

# Recriar cluster
kind create cluster --config k8s/kind-config.yaml
```

### Problema 2: Pods ficam em estado Pending
```bash
# Erro: "0/1 nodes are available"
# Verificar recursos do cluster
kubectl describe nodes

# Verificar eventos
kubectl get events --sort-by=.metadata.creationTimestamp

# Poss√≠vel solu√ß√£o: Reduzir recursos no deployment
kubectl edit deployment fastapi-app
```

### Problema 3: Pods n√£o passam no health check
```bash
# Erro: "Readiness probe failed"
# Verificar logs dos pods
kubectl logs -l app=fastapi-app

# Verificar se endpoint /time responde
kubectl exec -it deployment/fastapi-app -- curl http://localhost:8000/time

# Ajustar health check se necess√°rio
kubectl edit deployment fastapi-app
```

### Problema 4: NodePort n√£o acess√≠vel
```bash
# Erro: "connection refused" em localhost:30001
# Verificar se port mapping est√° correto
kubectl get svc fastapi-service -o yaml

# Verificar configura√ß√£o Kind
kind get clusters
docker port fastapi-cluster-control-plane

# Alternativa: usar port-forward
kubectl port-forward service/fastapi-service 8080:80
```

### Problema 5: Imagem n√£o encontrada
```bash
# Erro: "ImagePullBackOff"
# Verificar nome da imagem no deployment
kubectl describe pod <pod-name>

# Verificar se imagem existe no Docker Hub
docker pull seu_usuario_dockerhub/fastapi-jenkins:latest

# Corrigir nome no deployment.yaml se necess√°rio
```

### Problema 6: Rolling update n√£o funciona
```bash
# Problema: Deploy n√£o atualiza pods
# For√ßar rolling restart
kubectl rollout restart deployment/fastapi-app

# Verificar status do rollout
kubectl rollout status deployment/fastapi-app

# Verificar hist√≥rico
kubectl rollout history deployment/fastapi-app
```

## üîç Comandos √öteis para Debug

```bash
# Verificar todos os recursos
kubectl get all -l app=fastapi-app

# Informa√ß√µes detalhadas do deployment
kubectl describe deployment fastapi-app

# Informa√ß√µes detalhadas dos pods
kubectl describe pods -l app=fastapi-app

# Verificar configura√ß√£o do service
kubectl get svc fastapi-service -o yaml

# Entrar no pod para debug
kubectl exec -it deployment/fastapi-app -- /bin/sh

# Verificar conectividade interna
kubectl exec -it deployment/fastapi-app -- curl http://fastapi-service:80/time
```

## üìå Importante

üí° **Prepara√ß√£o para Pipeline Jenkins:**
- ‚úÖ **Manifests prontos** - Jenkins aplicar√° automaticamente
- ‚úÖ **Health checks** - Garantem deploy seguro
- ‚úÖ **NodePort configurado** - Acesso externo funcionando
- ‚úÖ **Rolling updates** - Deploy sem downtime
- ‚úÖ **Labels organizados** - Sele√ß√£o precisa pelo Jenkins

Para d√∫vidas ou problemas:
1. Verificar se Docker est√° rodando (necess√°rio para Kind)
2. Confirmar que cluster Kind foi criado corretamente
3. Validar que imagem Docker Hub est√° acess√≠vel
4. Testar health checks manualmente se pods n√£o ficam Ready

---

## üéØ Pr√≥xima Fase

**‚û°Ô∏è Pr√≥ximo passo:** [Fase 4 - Pipeline Jenkins Build e Push](fase4-jenkins-pipeline.md)

Na Fase 4, vamos:
- üîß Configurar Jenkins com pipeline como c√≥digo
- üê≥ Implementar stage de build Docker autom√°tico
- üöÄ Configurar push autom√°tico para Docker Hub
- ü§ñ Configurar webhook GitHub para triggers autom√°ticos

**üéØ Status:** Fase 3 conclu√≠da - Aplica√ß√£o rodando em Kubernetes com alta disponibilidade!

### üí° Prepara√ß√£o para Fase 4

Com a Fase 3 conclu√≠da, voc√™ tem:
- ‚úÖ **Aplica√ß√£o no Kubernetes** rodando com 2 r√©plicas
- ‚úÖ **Health checks** autom√°ticos funcionando
- ‚úÖ **Acesso externo** via NodePort 30001
- ‚úÖ **Manifests prontos** para automa√ß√£o Jenkins